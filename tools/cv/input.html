<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Input Form</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2D3A4B;
            --secondary-color: #E6E8EB;
            --text-color: #333333;
            --text-light: #666666;
            --white: #FFFFFF;
            --border-color: #D1D5DB;
            --focus-ring: #2D3A4B;
            --danger-color: #EF4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #F3F4F6;
            color: var(--text-color);
            line-height: 1.5;
            padding: 40px 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }

        .header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        form {
            padding: 40px;
        }

        section {
            margin-bottom: 40px;
            border-bottom: 1px solid var(--secondary-color);
            padding-bottom: 30px;
        }

        section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        h2 {
            color: var(--primary-color);
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
        }

        h2::after {
            content: '';
            flex: 1;
            height: 1px;
            background-color: var(--secondary-color);
            margin-left: 15px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
        }

        input {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            color: var(--text-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--focus-ring);
            box-shadow: 0 0 0 3px rgba(45, 58, 75, 0.1);
        }

        /* Job Details Styles */
        .job-item {
            background-color: #F9FAFB;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .job-header h3 {
            font-size: 16px;
            color: var(--text-light);
            font-weight: 500;
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .remove-btn:hover {
            background-color: #FEE2E2;
        }

        .add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .add-btn:hover {
            background-color: #1a232e;
        }

        .add-btn i {
            font-style: normal;
            font-size: 18px;
            line-height: 1;
        }

        @media (max-width: 768px) {
            #eduContainer div.edu-item {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            #eduContainer div.edu-item input {
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="header">
            <h1>CV Details Input</h1>
        </header>

        <form id="cvForm">
            <!-- Contact Section -->
            <section>
                <h2>Contact</h2>
                <div class="grid">
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="name" name="name" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" name="phone" placeholder="+123 456 7890">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="john@example.com">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="photo">Profile Photo</label>
                    <input type="file" id="photo" name="photo" accept="image/*">
                    <small style="color: #666;">Recommended: Square image, max 1MB</small>
                </div>
            </section>

            <!-- Personal Section -->
            <section>
                <h2>Personal</h2>
                <div class="grid">
                    <div class="form-group">
                        <label for="qid_no">QID No</label>
                        <input type="text" id="qid_no" name="qid_no">
                    </div>
                    <div class="form-group">
                        <label for="qid_exp">QID Exp</label>
                        <input type="date" id="qid_exp" name="qid_exp" list="qid_exp_list">
                    </div>
                    <div class="form-group">
                        <label for="dob">DOB</label>
                        <input type="date" id="dob" name="dob" list="dob_list">
                    </div>
                    <div class="form-group">
                        <label for="passport_no">Passport No</label>
                        <input type="text" id="passport_no" name="passport_no">
                    </div>
                    <div class="form-group">
                        <label for="passport_exp">Passport Exp</label>
                        <input type="date" id="passport_exp" name="passport_exp" list="passport_exp_list">
                    </div>
                </div>
            </section>



            <!-- History Datalists for Personal Section -->
            <datalist id="qid_exp_list"></datalist>
            <datalist id="dob_list"></datalist>
            <datalist id="passport_exp_list"></datalist>

            <!-- Job Details Section -->
            <section id="jobSection">
                <h2>Job Details</h2>
                <div id="jobsContainer">
                    <!-- Job items will be added here -->
                    <div class="job-item">
                        <div class="job-header">
                            <h3>Job #1</h3>
                        </div>
                        <div class="grid">
                            <div class="form-group">
                                <label>Job Title</label>
                                <input type="text" name="job_title[]" placeholder="Marketing Manager">
                            </div>
                            <div class="form-group">
                                <label>Company</label>
                                <input type="text" name="company[]" placeholder="Acme Corp">
                            </div>
                            <div class="form-group">
                                <label>Location</label>
                                <input type="text" name="location[]" placeholder="New York, USA">
                            </div>
                            <div class="form-group">
                                <label>Working Year</label>
                                <input type="text" name="working_year[]" placeholder="2020">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Context Section -->
                <section>
                    <h2>Target Role Context</h2>
                    <div class="grid">
                        <div class="form-group">
                            <label for="target_job_title">Target Job Title</label>
                            <input type="text" id="target_job_title" name="target_job_title"
                                placeholder="e.g. Senior Marketing Manager">
                        </div>
                        <div class="form-group">
                            <label for="total_experience">Total Years Experience</label>
                            <input type="text" id="total_experience" name="total_experience"
                                placeholder="e.g. 10 Years">
                        </div>
                    </div>
                </section>

                <button type="button" class="add-btn" id="addJobBtn">
                    <i>+</i> Add Another Job
                </button>
            </section>

            <!-- Other Information Section -->
            <section>
                <h2>OTHER INFORMAITON</h2>


                <!-- Education -->
                <div style="margin-bottom: 30px;" class="edu-section">
                    <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #000;">Education:</h3>
                    <div id="eduContainer">
                        <div class="edu-item"
                            style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <input type="text" name="edu_degree[]" placeholder="degree name" style="flex: 1;">
                            <input type="text" name="edu_school[]" placeholder="school/collage name" style="flex: 1;">
                            <input type="text" name="edu_country[]" placeholder="country name" style="flex: 1;">

                            <div class="action-buttons" style="display: flex; flex-wrap: wrap; gap: 5px;">
                                <button type="button" class="add-btn-small" onclick="addEducation()"
                                    style="width: 30px; height: 30px; background: #000; color: #fff; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
                                <button type="button" class="remove-btn-small"
                                    onclick="this.closest('.edu-item').remove()"
                                    style="width: 30px; height: 30px; background: #000; color: #fff; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">-</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Languages -->
                <div>
                    <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #000;">Select Language:
                    </h3>
                    <div id="langContainer">
                        <div class="lang-item"
                            style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <select name="language[]"
                                style="flex: 1; padding: 10px; border: 1px solid #D1D5DB; border-radius: 6px;">
                                <option value="" disabled selected>Select Language</option>
                                <option value="Arabic">Arabic</option>
                                <option value="English">English</option>
                                <option value="Hindi">Hindi</option>
                                <option value="Bangla">Bangla</option>
                                <option value="Nepali">Nepali</option>
                                <option value="Philipini">Philipini</option>
                            </select>

                            <div class="action-buttons" style="display: flex; gap: 5px;">
                                <button type="button" class="add-btn-small" onclick="addLanguage()"
                                    style="width: 30px; height: 30px; background: #000; color: #fff; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
                                <button type="button" class="remove-btn-small"
                                    onclick="this.closest('.lang-item').remove()"
                                    style="width: 30px; height: 30px; background: #000; color: #fff; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">-</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <div style="margin-top: 40px; text-align: center;">
                <button type="submit"
                    style="background-color: var(--primary-color); color: white; padding: 15px 40px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;">
                    Generate CV
                </button>
            </div>
        </form>
    </div>

    <script>
        const GEMINI_API_KEY = 'AIzaSyA7GsuaemKgTTbvXlpckp0vrYfpCEdQBmM'; // Configured by User

        document.addEventListener('DOMContentLoaded', () => {
            const jobsContainer = document.getElementById('jobsContainer');
            const addJobBtn = document.getElementById('addJobBtn');
            const jobTemplate = document.querySelector('.job-item').cloneNode(true);

            // Templates for new sections
            const eduContainer = document.getElementById('eduContainer');
            // Create template based on current HTML structure
            const eduTemplateContent = `
                <div class="edu-item" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <input type="text" name="edu_degree[]" placeholder="degree name" style="flex: 1;">
                    <input type="text" name="edu_school[]" placeholder="school/collage name" style="flex: 1;">
                    <input type="text" name="edu_country[]" placeholder="country name" style="flex: 1;">
                    
                    <div class="action-buttons" style="display: flex; gap: 5px;">
                        <button type="button" class="add-btn-small" onclick="addEducation()" style="width: 30px; height: 30px; background: #000; color: #fff; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
                        <button type="button" class="remove-btn-small" onclick="this.closest('.edu-item').remove()" style="width: 30px; height: 30px; background: #000; color: #fff; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">-</button>
                    </div>
                </div>
            `;

            const langContainer = document.getElementById('langContainer');
            const langTemplateContent = `
                <div class="lang-item" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <select name="language[]" style="flex: 1; padding: 10px; border: 1px solid #D1D5DB; border-radius: 6px;">
                        <option value="" disabled selected>Select Language</option>
                        <option value="Arabic">Arabic</option>
                        <option value="English">English</option>
                        <option value="Hindi">Hindi</option>
                        <option value="Bangla">Bangla</option>
                        <option value="Nepali">Nepali</option>
                        <option value="Philipini">Philipini</option>
                    </select>
                    
                    <div class="action-buttons" style="display: flex; gap: 5px;">
                        <button type="button" class="add-btn-small" onclick="addLanguage()" style="width: 30px; height: 30px; background: #000; color: #fff; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
                        <button type="button" class="remove-btn-small" onclick="this.closest('.lang-item').remove()" style="width: 30px; height: 30px; background: #000; color: #fff; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">-</button>
                    </div>
                </div>
            `;

            // Global add functions to be accessible from HTML
            window.addEducation = function () {
                const div = document.createElement('div');
                div.innerHTML = eduTemplateContent.trim();
                eduContainer.appendChild(div.firstChild);
            };

            window.addLanguage = function () {
                const div = document.createElement('div');
                div.innerHTML = langTemplateContent.trim();
                langContainer.appendChild(div.firstChild);
            };

            let profilePhotoBase64 = null; // Store base64 string

            // Handle File Input
            document.getElementById('photo').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        profilePhotoBase64 = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // ... (Date History Logic - same as before) ...
            function saveDateHistory(fieldId, value) {
                if (!value) return;
                const history = JSON.parse(localStorage.getItem('cvDateHistory') || '{}');
                if (!history[fieldId]) history[fieldId] = [];
                const index = history[fieldId].indexOf(value);
                if (index > -1) history[fieldId].splice(index, 1);
                history[fieldId].unshift(value);
                if (history[fieldId].length > 10) history[fieldId].length = 10;
                localStorage.setItem('cvDateHistory', JSON.stringify(history));
            }

            function loadDateHistory() {
                const history = JSON.parse(localStorage.getItem('cvDateHistory') || '{}');
                ['qid_exp', 'dob', 'passport_exp'].forEach(fieldId => {
                    const list = document.getElementById(fieldId + '_list');
                    if (list && history[fieldId]) {
                        list.innerHTML = '';
                        history[fieldId].forEach(val => {
                            const opt = document.createElement('option');
                            opt.value = val;
                            list.appendChild(opt);
                        });
                    }
                });
            }

            // Function to update job numbers and handle remove buttons
            function updateJobs() {
                const jobItems = jobsContainer.querySelectorAll('.job-item:not(.edu-item):not(.lang-item)');
                jobItems.forEach((item, index) => {
                    const title = item.querySelector('h3');
                    if (title) title.textContent = `Job #${index + 1}`;

                    let removeBtn = item.querySelector('.remove-btn');
                    if (index > 0) {
                        if (!removeBtn) {
                            const header = item.querySelector('.job-header');
                            removeBtn = document.createElement('button');
                            removeBtn.type = 'button';
                            removeBtn.className = 'remove-btn';
                            removeBtn.textContent = 'Remove';
                            removeBtn.onclick = () => {
                                item.remove();
                                updateJobs();
                            };
                            header.appendChild(removeBtn);
                        }
                    } else {
                        if (removeBtn) removeBtn.remove();
                    }
                });
            }

            // Persistence Logic
            const entries = performance.getEntriesByType("navigation");
            let navigationType = entries.length > 0 ? entries[0].type : "navigate";

            if (navigationType === 'reload') {
                localStorage.removeItem('cvData');
            }

            // Restore Data if available
            const savedData = JSON.parse(localStorage.getItem('cvData'));
            if (savedData) {
                // ... (Existing restore logic for Contact/Personal) ...

                // Education
                if (savedData.education && savedData.education.length > 0) {
                    eduContainer.innerHTML = '';
                    savedData.education.forEach(edu => {
                        const div = document.createElement('div');
                        div.innerHTML = eduTemplateContent.trim();
                        const newEdu = div.firstChild;
                        newEdu.querySelector('[name="edu_degree[]"]').value = edu.degree || '';
                        newEdu.querySelector('[name="edu_school[]"]').value = edu.school || '';
                        newEdu.querySelector('[name="edu_country[]"]').value = edu.country || '';
                        eduContainer.appendChild(newEdu);
                    });
                } else {
                    // Ensure at least one empty
                    eduContainer.innerHTML = '';
                    addEducation();
                }

                // Languages
                if (savedData.languages && savedData.languages.length > 0) {
                    langContainer.innerHTML = '';
                    savedData.languages.forEach(lang => {
                        const div = document.createElement('div');
                        div.innerHTML = langTemplateContent.trim();
                        const newLang = div.firstChild;
                        newLang.querySelector('[name="language[]"]').value = lang || '';
                        langContainer.appendChild(newLang);
                    });
                } else {
                    langContainer.innerHTML = '';
                    addLanguage();
                }

                // Contact
                if (savedData.contact) {
                    document.getElementById('name').value = savedData.contact.name || '';
                    document.getElementById('phone').value = savedData.contact.phone || '';
                    document.getElementById('email').value = savedData.contact.email || '';
                    profilePhotoBase64 = savedData.contact.photo; // Restore internal var, input can't be set
                }
                // Personal
                if (savedData.personal) {
                    document.getElementById('qid_no').value = savedData.personal.qid || '';
                    document.getElementById('qid_exp').value = savedData.personal.qid_exp || '';
                    document.getElementById('dob').value = savedData.personal.dob || '';
                    document.getElementById('passport_no').value = savedData.personal.passport_no || '';
                    document.getElementById('passport_exp').value = savedData.personal.passport_exp || '';
                }
                // Target
                document.getElementById('target_job_title').value = savedData.target_job_title || '';
                document.getElementById('total_experience').value = savedData.total_experience || '';

                // Jobs
                if (savedData.jobs && savedData.jobs.length > 0) {
                    jobsContainer.innerHTML = ''; // Clear default
                    savedData.jobs.forEach(job => {
                        const newJob = jobTemplate.cloneNode(true);
                        newJob.querySelector('[name="job_title[]"]').value = job.title || '';
                        newJob.querySelector('[name="company[]"]').value = job.company || '';
                        newJob.querySelector('[name="location[]"]').value = job.location || '';
                        newJob.querySelector('[name="working_year[]"]').value = job.working_year || '';
                        jobsContainer.appendChild(newJob);
                    });
                }
            }

            // Initial update
            updateJobs();
            loadDateHistory();

            addJobBtn.addEventListener('click', () => {
                const newJob = jobTemplate.cloneNode(true);
                // Clear inputs
                newJob.querySelectorAll('input').forEach(input => input.value = '');
                jobsContainer.appendChild(newJob);
                updateJobs();
            });


            // Handle Form Submit
            // Handle Form Submit
            document.getElementById('cvForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const submitBtn = this.querySelector('button[type="submit"]');

                if (GEMINI_API_KEY === 'YOUR_API_KEY_HERE' || !GEMINI_API_KEY) {
                    alert('API Key is missing. Please check the code configuration.');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.innerText = 'Generating Content...';

                // 1. Gather Basic Data
                const formData = new FormData(this);

                // Save Date History
                saveDateHistory('qid_exp', formData.get('qid_exp'));
                saveDateHistory('dob', formData.get('dob'));
                saveDateHistory('passport_exp', formData.get('passport_exp'));

                const cvData = {
                    contact: {
                        name: formData.get('name'),
                        phone: formData.get('phone'),
                        email: formData.get('email'),
                        photo: profilePhotoBase64 // Add photo data
                    },
                    personal: {
                        qid: formData.get('qid_no'),
                        qid_exp: formData.get('qid_exp'),
                        dob: formData.get('dob'),
                        passport_no: formData.get('passport_no'),
                        passport_exp: formData.get('passport_exp')
                    },
                    target_job_title: formData.get('target_job_title'),
                    total_experience: formData.get('total_experience'),
                    jobs: [],
                    education: [],
                    languages: [],
                    ai_content: {
                        summary: "",
                        skills: []
                    }
                };

                // 2. Gather Repeater Job Data
                // Use specific selector to avoid grabbing edu/lang items which also have job-item class
                document.querySelectorAll('#jobsContainer .job-item').forEach(item => {
                    const title = item.querySelector('[name="job_title[]"]')?.value;
                    const company = item.querySelector('[name="company[]"]')?.value;
                    const location = item.querySelector('[name="location[]"]')?.value;
                    const working_year = item.querySelector('[name="working_year[]"]')?.value;

                    if (title || company) {
                        cvData.jobs.push({
                            title: title,
                            company: company,
                            location: location,
                            working_year: working_year,
                            bullets: []
                        });
                    }
                });

                // Gather Education
                document.querySelectorAll('.edu-item').forEach(item => {
                    const degree = item.querySelector('[name="edu_degree[]"]').value;
                    const school = item.querySelector('[name="edu_school[]"]').value;
                    const country = item.querySelector('[name="edu_country[]"]').value;
                    if (degree || school) {
                        cvData.education.push({ degree, school, country });
                    }
                });

                // Gather Languages
                document.querySelectorAll('.lang-item').forEach(item => {
                    const lang = item.querySelector('[name="language[]"]').value;
                    if (lang) {
                        cvData.languages.push(lang);
                    }
                });

                // 3. Call Gemini API
                try {
                    const jobDetailsText = cvData.jobs.map((job, i) =>
                        `Job ${i + 1}: ${job.title} at ${job.company} (${job.location}, ${job.working_year})`
                    ).join('\n');

                    // Dynamic Constraints based on job count
                    let maxBullets = 4;
                    if (cvData.jobs.length > 2) {
                        maxBullets = 3; // Strict limit for 3+ jobs to fit A4
                    }

                    const prompt = `
                        Role: Expert Resume Writer.
                        Task: Generate a professional summary, skills list, and bullet points for a CV.
                        Context:
                        - Target Role: ${cvData.target_job_title}
                        - Total Experience: ${cvData.total_experience}
                        - Jobs: 
                        ${jobDetailsText}

                        Constraints:
                        - SUMMARY: STRICTLY MAX 50 WORDS MIN 40 WORDS.
                        - BULLET POINTS: EXACTLY ${maxBullets} PER JOB. NO MORE.
                        - BULLET LENGTH: VERY SHORT. MAX 10 WORDS PER BULLET.

                        Examples:
                        - "Managed team of 5." (Good - Short)
                        - "Responsible for managing a cross-functional team of 5 people to deliver projects." (Bad - Too long)

                        Output Format: JSON ONLY. No markdown formatting.
                        Structure:
                        {
                            "summary": "Professional summary...",
                            "skills": ["Skill 1", "Skill 2", "Skill 3", "Skill 4", "Skill 5", "Skill 6"],
                            "job_bullets": [
                                ["Bullet 1", "Bullet 2"], // EXACTLY ${maxBullets} Items
                                ... 
                            ]
                        }
                    `;

                    const makeRequest = async (retries = 3, delay = 2000) => {
                        for (let i = 0; i < retries; i++) {
                            try {
                                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${GEMINI_API_KEY}`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        contents: [{
                                            parts: [{
                                                text: prompt
                                            }]
                                        }],
                                        safetySettings: [{
                                            category: "HARM_CATEGORY_HARASSMENT",
                                            threshold: "BLOCK_ONLY_HIGH"
                                        },
                                        {
                                            category: "HARM_CATEGORY_HATE_SPEECH",
                                            threshold: "BLOCK_ONLY_HIGH"
                                        },
                                        {
                                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                            threshold: "BLOCK_ONLY_HIGH"
                                        },
                                        {
                                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                            threshold: "BLOCK_ONLY_HIGH"
                                        }
                                        ]
                                    })
                                });

                                if (response.status === 503) {
                                    console.warn(`Attempt ${i + 1} failed with 503. Retrying in ${delay}ms...`);
                                    await new Promise(res => setTimeout(res, delay));
                                    continue;
                                }

                                if (!response.ok) {
                                    const errorText = await response.text();
                                    throw new Error(`API Request Failed: ${response.status} - ${errorText}`);
                                }

                                return response;
                            } catch (err) {
                                if (i === retries - 1) throw err;
                            }
                        }
                    };

                    const response = await makeRequest();

                    const data = await response.json();

                    if (!data.candidates || data.candidates.length === 0) {
                        console.error('Full API Response:', data);
                        let msg = 'No content generated.';
                        if (data.promptFeedback) {
                            msg += ` Safety Reason: ${JSON.stringify(data.promptFeedback)}`;
                        }
                        throw new Error(msg);
                    }

                    const candidate = data.candidates[0];
                    if (!candidate.content || !candidate.content.parts || candidate.content.parts.length === 0) {
                        console.error('Incomplete Candidate:', candidate);
                        throw new Error('API returned no content parts. Check safety settings or prompt.');
                    }
                    let responseText = candidate.content.parts[0].text;

                    // Clean code blocks if present
                    responseText = responseText.replace(/```json/g, '').replace(/```/g, '').trim();

                    const aiResult = JSON.parse(responseText);

                    // 3. Merge AI Data
                    cvData.ai_content.summary = aiResult.summary;
                    cvData.ai_content.skills = aiResult.skills;

                    // Merge bullets back to jobs with Strict Client-Side Enforcement
                    cvData.jobs.forEach((job, index) => {
                        if (aiResult.job_bullets && aiResult.job_bullets[index]) {
                            // Enforce Max Bullets Client-Side
                            let bullets = aiResult.job_bullets[index];
                            if (bullets.length > maxBullets) {
                                bullets = bullets.slice(0, maxBullets);
                            }

                            // Enforce Max Words Client-Side (Soft truncate)
                            bullets = bullets.map(b => {
                                const words = b.split(' ');
                                if (words.length > 12) { // Allow slight buffer
                                    return words.slice(0, 10).join(' ') + '.';
                                }
                                return b;
                            });

                            job.bullets = bullets;
                        } else {
                            job.bullets = ["Content generation failed for this item."];
                        }
                    });

                    // 4. Save and Redirect
                    localStorage.setItem('cvData', JSON.stringify(cvData));

                    const selectedTemplate = localStorage.getItem('selectedTemplate') || 'modern';
                    window.location.href = `templates/${selectedTemplate}.html`;

                } catch (error) {
                    console.error('Error:', error);
                    alert(`Failed to generate content. Error: ${error.message}`);
                    submitBtn.disabled = false;
                    submitBtn.innerText = 'Generate CV';
                }
            });
        });
    </script>
</body>

</html>