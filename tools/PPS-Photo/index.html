<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passport Photo Generator - Qatar</title>
    <script>
        // Session Enforcement Script
        (async function () {
            // Use sessionStorage (Session only)
            const userId = sessionStorage.getItem('pps_userId');
            const token = sessionStorage.getItem('pps_token');

            // Cleanup any old localStorage items just in case
            localStorage.removeItem('pps_userId');
            localStorage.removeItem('pps_token');

            if (!userId || !token) {
                window.location.href = 'login.html';
                return;
            }

            // Verify with server
            try {
                const res = await fetch('http://localhost:3000/api/verify-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, token })
                });
                const data = await res.json();

                if (!data.valid) {
                    alert('Session expired or logged in from another device.');
                    sessionStorage.clear();
                    window.location.href = 'http://localhost:3000/tools/PPS-Photo/login.html';
                }
            } catch (e) {
                console.error('Auth check failed', e);
            }
        })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: auto;
            display: block;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            width: 100%;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .content {
            display: flex;
            flex-direction: column;
            gap: 30px;
            width: 100%;
        }

        /* Row 1: Upload Section */
        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .api-key-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }

        .api-key-section label {
            color: #333;
            font-weight: 500;
            font-size: 13px;
        }

        .api-key-section input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }

        .api-key-section input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .api-key-section small {
            color: #999;
            font-size: 12px;
        }

        .api-key-section a {
            color: #667eea;
            text-decoration: none;
        }

        .api-key-section a:hover {
            text-decoration: underline;
        }

        .upload-box {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-box.active {
            border-color: #667eea;
            background: #e8ecff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .upload-text {
            color: #333;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .upload-subtext {
            color: #999;
            font-size: 13px;
        }

        #fileInput {
            display: none;
        }

        .status-message {
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }

        .status-message.show {
            display: block;
        }

        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }

        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }

        .status-message.info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #2196f3;
        }

        /* Row 2: Images Side by Side - Passport Size (2:3 aspect ratio) */
        .images-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            width: 100%;
        }

        .image-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .image-column-title {
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .image-container {
            width: 100%;
            max-width: 143px;
            aspect-ratio: 38 / 48;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #ddd;
            position: relative;
        }

        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .preview-image.show {
            display: block;
        }

        .preview-placeholder {
            color: #999;
            font-size: 12px;
            text-align: center;
            padding: 12px;
        }

        .preview-placeholder.hidden {
            display: none;
        }

        .result-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .result-image.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .result-placeholder {
            color: #999;
            font-size: 12px;
            text-align: center;
            padding: 12px;
        }

        .result-placeholder.hidden {
            display: none;
        }

        .loading-spinner {
            display: none;
            width: 30px;
            height: 30px;
            border: 3px solid #f5f5f5;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
        }

        .loading-spinner.show {
            display: block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .button-group {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e8e8e8;
        }

        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .download-btn {
            background: #4caf50;
            color: white;
            display: none;
        }

        .download-btn:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
        }

        .download-btn.show {
            display: block;
        }

        /* Row 3: Customization Side by Side */
        .customization-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            width: 100%;
        }

        .customization-section {
            background: #f9f9f9;
            padding: 16px;
            border-radius: 8px;
        }

        .customization-title {
            color: #333;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 12px;
        }

        .option-group:last-child {
            margin-bottom: 0;
        }

        .option-label {
            color: #555;
            font-size: 13px;
            font-weight: 500;
            display: block;
            margin-bottom: 6px;
        }

        .color-picker-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        input[type="color"] {
            width: 50px;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
        }

        input[type="color"]:hover {
            border-color: #667eea;
        }

        .color-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
        }

        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            width: 100%;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Page Management */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Print Page Styles */
        .print-page-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .print-page-header h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .layout-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
        }

        .layout-title {
            color: #333;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .layout-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .layout-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .layout-option:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .layout-option input[type="radio"] {
            cursor: pointer;
        }

        .layout-option label {
            cursor: pointer;
            flex: 1;
            margin: 0;
        }

        /* A4 Print Area */
        .a4-print-area {
            width: 210mm;
            height: 297mm;
            background: white;
            margin: 20px auto;
            padding: 10mm;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: grid;
            gap: 8mm;
            align-content: start;
        }

        .a4-row {
            display: grid;
            gap: 8mm;
            grid-auto-flow: column;
            justify-items: center;
        }

        .a4-photo {
            width: 38mm;
            height: 48mm;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f5f5f5;
        }

        .a4-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .print-button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            justify-content: center;
        }

        /* Media print styles */
        @media print {
            body {
                visibility: hidden;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Hide the main container and everything else */
            .container,
            .header,
            .content,
            .button-group {
                display: none !important;
            }

            /* Specifically visible the print page and its children */
            #printPage,
            #printPage * {
                visibility: visible;
            }

            #printPage {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                display: block !important;
                /* Ensure it is displayed */
            }

            /* Hide print UI elements */
            .print-page-header,
            .layout-section,
            .print-button-group,
            .page-navigation {
                display: none !important;
            }

            .a4-print-area {
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 10mm;
                box-shadow: none;
                border: none;
                page-break-after: always;
                display: grid !important;
                /* Position correctly within the absolute container */
                margin-left: auto;
                margin-right: auto;
            }

            @page {
                margin: 0;
                size: auto;
            }
        }

        .page-navigation {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-back {
            background: #999;
            color: white;
        }

        .btn-back:hover:not(:disabled) {
            background: #777;
            transform: translateY(-2px);
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .container {
                max-width: 900px;
                padding: 30px;
            }

            .customization-row {
                grid-template-columns: 1fr 1fr;
            }

            .images-row {
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .images-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .customization-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .image-container {
                max-width: 110px;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .upload-box {
                padding: 24px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }

            .header h1 {
                font-size: 20px;
            }

            .upload-box {
                padding: 16px;
            }

            .image-container {
                max-width: 85px;
            }

            .customization-title {
                font-size: 12px;
            }
        }

        /* --- NEW STYLES FOR TOOLBAR & PRINT PAGE --- */
        .pdf-toolbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #2D3A4B;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .pdf-toolbar .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .pdf-toolbar .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Wrapper to simulate the "Classic" look */
        #printPage {
            background-color: #525659;
            /* Desktop gray background */
            min-height: 100vh;
            padding-top: 80px;
            /* Space for toolbar */
            display: none;
            flex-direction: column;
            align-items: center;
            position: absolute;
            /* Override .page absolute */
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
        }

        #printPage.active {
            display: flex;
        }

        /* The A4 representation */
        .print-sheet {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            margin: 20px auto;
            padding: 2mm;
            /* Default, adjustable via JS */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 3.5mm;
            /* Default gap, adjustable */
            transform-origin: top center;
        }

        .a4-row {
            display: flex;
            justify-content: center;
            /* Center rows horizontally */
            gap: 10mm;
            /* Horizontal gap, adjustable */
            width: 100%;
        }

        .a4-photo {
            width: 38mm;
            /* Default width */
            aspect-ratio: 38 / 48;
            background: #eee;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            /* Inner padding adjustable */
            border: 1px dashed #ddd;
            /* Helper border for visual */
        }

        .a4-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        @media print {
            .pdf-toolbar {
                display: none !important;
            }

            #printPage {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: white;
                padding: 0;
                display: block !important;
                overflow: visible;
            }

            .print-sheet {
                box-shadow: none;
                margin: 0;
                width: 100%;
                height: 100%;
                page-break-after: always;
            }

            .container,
            .page {
                display: none !important;
            }

            #printPage.active {
                display: block !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="generatorPage" class="page active">
            <div class="header">
                <h1>Passport Size Photo Generator</h1>
                <p>Generate professional passport Size photos using AI</p>
            </div>

            <div class="content">
                <!-- Row 1: Upload Section -->
                <div class="upload-section">
                    <div class="api-key-section" style="display: none;">
                        <!-- API Key managed by Server -->
                    </div>

                    <div class="upload-box" id="uploadBox">
                        <div class="upload-icon">üì∑</div>
                        <div class="upload-text">Click to upload or drag & drop</div>
                        <div class="upload-subtext">PNG, JPG or WebP (Max 10MB)</div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" />

                    <div id="statusMessage" class="status-message"></div>
                </div>

                <!-- Row 2: Images Side by Side (Passport Size 2:3) -->
                <div class="images-row">
                    <!-- Selected Image -->
                    <div class="image-column">
                        <div class="image-column-title">üì∏ Selected Image</div>
                        <div class="image-container">
                            <img id="previewImage" class="preview-image" alt="Preview" />
                            <div id="previewPlaceholder" class="preview-placeholder">No image selected</div>
                        </div>
                    </div>

                    <!-- Generated Image -->
                    <div class="image-column">
                        <div class="image-column-title">‚ú® Generated Photo</div>
                        <div class="image-container">
                            <div class="loading-spinner" id="loadingSpinner"></div>
                            <img id="resultImage" class="result-image" alt="Generated result" />
                            <div id="resultPlaceholder" class="result-placeholder">Generated image will appear here
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Customization Side by Side -->
                <div class="customization-row">
                    <!-- Background Color -->
                    <div class="customization-section">
                        <div class="customization-title">üé® Background</div>
                        <div class="option-group">
                            <label class="option-label">Color</label>
                            <div class="color-picker-group">
                                <input type="color" id="bgColorPicker" value="#ffffff" />
                                <input type="text" id="bgColorInput" class="color-input" value="#ffffff"
                                    placeholder="#ffffff" />
                            </div>
                        </div>
                    </div>

                    <!-- Suit Selection -->
                    <div class="customization-section">
                        <div class="customization-title">üëî Suit</div>
                        <div class="option-group">
                            <label class="option-label">Color</label>
                            <select id="suitColor">
                                <option value="keep original">Keep Original Outfit</option>
                                <option value="dark business suit">Dark Business Suit</option>
                                <option value="black suit">Black Suit</option>
                                <option value="navy blue suit">Navy Blue Suit</option>
                                <option value="charcoal gray suit">Charcoal Gray Suit</option>
                                <option value="dark gray suit">Dark Gray Suit</option>
                                <option value="custom suit">Custom Color</option>
                            </select>
                            <input type="color" id="customSuitColor" value="#1a1a1a" style="display: none;" />
                        </div>
                    </div>

                    <!-- Tie Selection -->
                    <div class="customization-section">
                        <div class="customization-title">üéÄ Tie</div>
                        <div class="option-group">
                            <label class="option-label">Color</label>
                            <select id="tieColor">
                                <option value="no tie">No Tie</option>
                                <option value="dark tie">Dark Tie</option>
                                <option value="black tie">Black Tie</option>
                                <option value="navy blue tie">Navy Blue Tie</option>
                                <option value="burgundy tie">Burgundy Tie</option>
                                <option value="gray tie">Gray Tie</option>
                                <option value="red tie">Red Tie</option>
                                <option value="custom tie">Custom Color</option>
                            </select>
                            <input type="color" id="customTieColor" value="#1a1a1a" style="display: none;" />
                        </div>
                    </div>
                </div>

            </div>

            <div class="button-group">
                <button class="btn-primary" id="generateBtn" disabled>Generate Passport Photo</button>
                <button class="btn-secondary" id="clearBtn">Clear</button>
                <button class="btn-primary download-btn" id="downloadBtn">‚¨áÔ∏è Download</button>
                <button class="btn-primary" id="nextPageBtn"
                    style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">üìÑ Next Page</button>
            </div>

            <!-- Extra Focus Input (Below Buttons) -->
            <div
                style="margin-top: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                <div
                    style="font-weight: 600; color: #333; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                    <span>‚úèÔ∏è Extra Focus / Custom Instructions</span>
                </div>
                <textarea id="extraPrompt"
                    placeholder="Example: Change the dress color to dark blue. Make the background slightly darker. Ensure the tie is straight."
                    style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; min-height: 80px; resize: vertical; font-family: inherit; box-sizing: border-box;"></textarea>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    * The AI will follow these instructions while preserving the face identity.
                </div>
            </div>
        </div>
    </div>

    <!-- Print Page (Redesigned) -->
    <div id="printPage" class="page">
        <!-- Toolbar -->
        <div class="pdf-toolbar">
            <button class="action-btn" onclick="document.getElementById('backBtn').click()"><i
                    class="fas fa-arrow-left"></i> Back</button>

            <div style="width: 1px; height: 20px; background: rgba(255,255,255,0.2); margin: 0 10px;"></div>

            <button class="action-btn" onclick="adjustLayout('padding', 1)" title="Increase Vertical Spacing"><i
                    class="fas fa-arrows-alt-v"></i> Top +</button>
            <button class="action-btn" onclick="adjustLayout('padding', -1)" title="Decrease Vertical Spacing"><i
                    class="fas fa-arrows-alt-v"></i> Top -</button>

            <button class="action-btn" onclick="adjustLayout('gap', 1)" title="Increase Gap"><i
                    class="fas fa-arrows-alt-h"></i> Gap +</button>
            <button class="action-btn" onclick="adjustLayout('gap', -1)" title="Decrease Gap"><i
                    class="fas fa-arrows-alt-h"></i> Gap -</button>

            <button class="action-btn" onclick="duplicateRow()" title="Duplicate Last Row"><i class="fas fa-copy"></i>
                Add Row</button>
            <button class="action-btn" onclick="removeRow()" title="Remove Last Row" style="color: #ff6b6b;"><i
                    class="fas fa-trash"></i>Delete Row</button>

            <select id="layoutSelect" class="action-btn"
                style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); width: auto;"
                onchange="generatePrintLayout()">
                <option value="4x1">Layout: 4 x 1</option>
                <option value="4x2">Layout: 4 x 2</option>
                <option value="2x2">Layout: 2 x 2</option>
                <option value="5x1" selected>Layout: 5 x 1 (Default)</option>
            </select>

            <div style="width: 1px; height: 20px; background: rgba(255,255,255,0.2); margin: 0 10px;"></div>

            <button class="action-btn" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
        </div>

        <!-- A4 Page representation -->
        <div id="a4Container" class="print-sheet">
            <!-- Rows will be injected here -->
        </div>

        <!-- Hidden button for logic compatibility -->
        <button id="backBtn" style="display:none;"></button>
    </div>
    </div>

    <script>
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');
        const previewImage = document.getElementById('previewImage');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const generateBtn = document.getElementById('generateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resultImage = document.getElementById('resultImage');
        const resultPlaceholder = document.getElementById('resultPlaceholder');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const statusMessage = document.getElementById('statusMessage');
        const downloadBtn = document.getElementById('downloadBtn');


        // Customization controls
        const bgColorPicker = document.getElementById('bgColorPicker');
        const bgColorInput = document.getElementById('bgColorInput');
        const suitColorSelect = document.getElementById('suitColor');
        const customSuitColor = document.getElementById('customSuitColor');
        const tieColorSelect = document.getElementById('tieColor');
        const customTieColor = document.getElementById('customTieColor');

        let selectedFile = null;
        let generatedImageUrl = null;
        let uploadedBase64 = null; // New fallback variable

        // Sync background color picker and input
        bgColorPicker.addEventListener('change', (e) => {
            bgColorInput.value = e.target.value;
            localStorage.setItem('bgColor', e.target.value);
        });

        bgColorInput.addEventListener('change', (e) => {
            bgColorPicker.value = e.target.value;
            localStorage.setItem('bgColor', e.target.value);
        });

        // Handle suit color selection
        suitColorSelect.addEventListener('change', (e) => {
            customSuitColor.style.display = e.target.value === 'custom suit' ? 'block' : 'none';
        });

        customSuitColor.addEventListener('change', (e) => {
            // No storage
        });

        // Handle tie color selection
        tieColorSelect.addEventListener('change', (e) => {
            customTieColor.style.display = e.target.value === 'custom tie' ? 'block' : 'none';
        });

        customTieColor.addEventListener('change', (e) => {
            // No storage
        });

        // Upload box click handler
        uploadBox.addEventListener('click', () => fileInput.click());

        // File input change handler
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFileSelect(file);
            }
        });

        // Drag and drop handlers
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('active');
        });

        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('active');
        });

        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('active');
            const file = e.dataTransfer.files[0];
            if (file) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect(file);
            }
        });

        function handleFileSelect(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showMessage('Please select a valid image file', 'error');
                return;
            }

            // Validate file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                showMessage('File size must be less than 10MB', 'error');
                return;
            }

            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedBase64 = e.target.result; // Store for fallback
                previewImage.src = e.target.result;
                previewImage.classList.add('show');
                previewPlaceholder.classList.add('hidden');
                generateBtn.disabled = false;
                showMessage(`Selected: ${file.name}`, 'info');
            };
            reader.readAsDataURL(file);
        }

        generateBtn.addEventListener('click', generatePassportPhoto);
        clearBtn.addEventListener('click', clearAll);
        downloadBtn.addEventListener('click', downloadImage);

        async function generatePassportPhoto() {
            if (!selectedFile) {
                showMessage('Please select an image first', 'error');
                return;
            }

            // API Key check moved to backend

            generateBtn.disabled = true;
            loadingSpinner.classList.add('show');
            resultImage.classList.remove('show');
            downloadBtn.classList.remove('show');
            showMessage('Processing your photo...', 'info');

            try {
                // Convert image to base64
                const base64Image = await fileToBase64(selectedFile);

                // Get customization values
                const bgColor = bgColorInput.value;
                const suitSelection = suitColorSelect.value;
                const tieSelection = tieColorSelect.value;

                // Build outfit instructions based on selections
                const keepOriginalOutfit = suitSelection === 'keep original';

                let outfitInstructions = '';
                if (keepOriginalOutfit && tieSelection === 'no tie') {
                    // Keep everything as is
                    outfitInstructions = `CLOTHING & OUTFIT:
- PRESERVE the person's original clothing/outfit. 
- Enhance the clearity of the outfit if it is blurry`;
                } else if (keepOriginalOutfit && tieSelection !== 'no tie') {
                    // Keep outfit but add/change tie
                    let tieInstruction = '';
                    if (tieSelection === 'custom tie') {
                        const customColor = customTieColor.value;
                        tieInstruction = `add a professional tie in color ${customColor}`;
                    } else {
                        tieInstruction = `add a professional ${tieSelection}`;
                    }
                    outfitInstructions = `CLOTHING & OUTFIT:
- PRESERVE the person's original clothing/outfit.
- DO NOT modify shirt, jacket, or other garments design.
- Enhance the clearity of the outfit if it is blurry
- Only ${tieInstruction} if not already wearing one, or update tie color if already present
`;
                } else {
                    // Change outfit
                    let suitColor = '';
                    let tieColor = '';

                    if (suitSelection === 'custom suit') {
                        const customColor = customSuitColor.value;
                        suitColor = `professional suit in color ${customColor}`;
                    } else {
                        suitColor = `professional ${suitSelection}`;
                    }

                    if (tieSelection === 'no tie') {
                        tieColor = 'without a tie';
                    } else if (tieSelection === 'custom tie') {
                        const customColor = customTieColor.value;
                        tieColor = `with a professional tie in color ${customColor}`;
                    } else {
                        tieColor = `with a professional ${tieSelection}`;
                    }

                    outfitInstructions = `CLOTHING & OUTFIT:
- CHANGE the person's outfit to wear a ${suitColor} ${tieColor}
- Replace current clothing with the new professional outfit
- Ensure the new outfit looks natural and professional`;
                }

                const bgDescription = bgColor === '#ffffff' ? 'Replace background with plain white' : `Replace background with solid color ${bgColor}`;

                // OLD LONG PROMPT - COMMENTED OUT (was causing AI confusion)
                /*
                const prompt = `You are an expert professional photo retouching AI. Your PRIMARY job is to enhance and beautify the face and skin. Process this passport photograph with extreme focus on face enhancement.

=== PRIMARY TASK: FACE & SKIN ENHANCEMENT ===
This is your MAIN priority - spend most processing power on face enhancement!

SKIN RETOUCHING (CRITICAL & AGGRESSIVE):
- REMOVE ALL dark spots, blemishes, acne, marks from face and neck
- REMOVE dark circles under eyes, shadows, and dark areas
- LIGHTEN and BRIGHTEN the entire face to look fresh and healthy
- SMOOTH skin texture while maintaining natural appearance
- REMOVE redness, yellowing, and any color imperfections
- EVEN OUT skin tone across entire face
- Make skin look clear, healthy, and professional
- ENHANCE facial color to appear vibrant but natural

FACIAL FEATURE ENHANCEMENT:
- BRIGHTEN and ENHANCE eyes to look alert and clear
- ENHANCE lips to look healthy and defined
- SHARPEN facial features for clarity
- Improve facial contrast subtly
- Make face look well-lit and professional

IMAGE CLARITY (MANDATORY):
- REMOVE ALL blur - make image crystal clear and sharp
- ENHANCE overall image sharpness significantly
- IMPROVE image clarity and definition
- ENHANCE colors to be vibrant and clear
- HIGH resolution output, not compressed

=== SECONDARY TASK: IDENTITY PRESERVATION ===
FACE & IDENTITY (DO NOT CHANGE):
- Keep the person's face structure and proportions EXACTLY the same
- DO NOT alter bone structure, face shape, or proportions
- DO NOT change the person's identity or recognizable features
- The person must remain clearly recognizable as the same individual
- Only BEAUTIFY and ENHANCE, do not ALTER facial structure

=== TERTIARY TASK: FRAMING & BACKGROUND ===
FRAMING & POSITIONING:
- Center the face in the frame
- Ensure person is looking directly at camera
- If head is tilted, straighten it to face directly forward
- Professional passport photo composition

BACKGROUND:
${bgDescription}

=== QUATERNARY TASK: OUTFIT ===
${outfitInstructions}

=== FINAL PROFESSIONAL ENHANCEMENTS ===
LIGHTING & PROFESSIONAL QUALITY:
- Apply professional studio lighting
- Even lighting across entire face
- NO shadows, NO dark areas
- Bright, clear, professional appearance
- Perfect for official government documents

COLOR & TONE:
- Enhance overall image color tone
- Make image look fresh and professional
- High quality, no artifacts
- Professional passport photo standard

QUALITY ASSURANCE:
- Face MUST be significantly clearer than original
- Skin MUST look healthier and cleaner
- Dark spots MUST be removed
- Image MUST be sharp and clear
- NO over-processing or artificial look
- Natural but enhanced and beautified appearance
- Professional quality suitable for official use`;
                */

                // NEW SIMPLIFIED PROMPT - Clear and concise for better AI understanding
                const prompt = `Create a professional passport photo from this image.

FACE ENHANCEMENT (PRIMARY FOCUS):
- Carefully examine the face and remove ALL blemishes, spots, acne, and skin imperfections
- Remove dark spots, dark circles, and shadows from the face and neck area
- Clear the face completely - make skin look clean and spotless
- Brighten the entire face evenly - enhance the facial color to look fresh and healthy
- Smooth skin texture naturally while keeping it realistic, not over-processed
- Make the face look clear, radiant, and professional

Keep the same person and identity exactly. Do not change face shape, facial proportions, or recognizable features.

Improve overall image clarity and sharpness. Remove blur completely.

Apply clean, even studio lighting with no harsh shadows on the face.

Center the face, align it straight, and ensure the person looks directly at the camera.

${bgDescription}.

${bgDescription}.

${outfitInstructions}

${document.getElementById('extraPrompt').value ? `IMPORTANT USER REQUEST:
- ${document.getElementById('extraPrompt').value}
- Follow this instruction strictly while maintaining other requirements.` : ''}`;

                // Call FAL AI API
                const requestBody = {
                    prompt: prompt,
                    image_urls: [base64Image],
                    num_images: 1,
                    output_format: 'png'
                };

                // Log the request for debugging
                console.log('FAL AI Request:', {
                    prompt: prompt,
                    imageSize: base64Image.length,
                    timestamp: new Date().toISOString()
                });

                // Call Backend Proxy
                const response = await fetch('http://localhost:3000/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        image_url: base64Image
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `API Error: ${response.status}`);
                }

                const result = await response.json();

                // Handle response from nano-banana/edit model
                if (result.images && result.images.length > 0) {
                    generatedImageUrl = result.images[0].url;
                    resultImage.src = result.images[0].url;
                    resultImage.classList.add('show');
                    resultPlaceholder.classList.add('hidden');
                    downloadBtn.classList.add('show');
                    showMessage('Photo generated successfully!', 'success');
                } else {
                    throw new Error('No images returned from API');
                }

            } catch (error) {
                console.error('Error:', error);
                showMessage(`Error: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                loadingSpinner.classList.remove('show');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function clearAll() {
            selectedFile = null;
            generatedImageUrl = null;
            fileInput.value = '';
            previewImage.src = '';
            previewImage.classList.remove('show');
            previewPlaceholder.classList.remove('hidden');
            resultImage.src = '';
            resultImage.classList.remove('show');
            resultPlaceholder.classList.remove('hidden');
            downloadBtn.classList.remove('show');
            generateBtn.disabled = true;
            statusMessage.innerHTML = '';
            statusMessage.classList.remove('show');

            // Reset customization
            bgColorPicker.value = '#ffffff';
            bgColorInput.value = '#ffffff';
            suitColorSelect.value = 'keep original';
            tieColorSelect.value = 'no tie';
            customSuitColor.style.display = 'none';
            customTieColor.style.display = 'none';
        }

        function downloadImage() {
            if (!generatedImageUrl) {
                showMessage('Please generate a photo first', 'error');
                return;
            }

            showMessage('Downloading image...', 'info');

            // Fetch the image as a blob and download it
            fetch(generatedImageUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to download image');
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Create blob URL
                    const blobUrl = window.URL.createObjectURL(blob);

                    // Create and trigger download
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = `passport-photo-${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();

                    // Cleanup
                    setTimeout(() => {
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(blobUrl);
                    }, 100);

                    showMessage('Image downloaded successfully!', 'success');
                })
                .catch(error => {
                    console.error('Download error:', error);
                    showMessage('Error downloading image. Please try again.', 'error');
                });
        }

        function showMessage(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message show ${type}`;
        }

        // API Key managed by server
        // const savedApiKey = localStorage.getItem('falApiKey');

        // Load customization preferences
        const savedBgColor = localStorage.getItem('bgColor');
        if (savedBgColor) {
            bgColorPicker.value = savedBgColor;
            bgColorInput.value = savedBgColor;
        }



        // Default Suit/Tie to 'keep original' (No storage loading)
        suitColorSelect.value = 'keep original';
        customSuitColor.style.display = 'none';

        tieColorSelect.value = 'keep original';
        customTieColor.style.display = 'none';

        // Page Navigation
        const generatorPage = document.querySelector('.page:first-of-type') || document.querySelector('[style*="display: block"]');
        const printPage = document.getElementById('printPage');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const backBtn = document.getElementById('backBtn');
        const a4Container = document.getElementById('a4Container');
        const layoutSelect = document.getElementById('layoutSelect');

        // Show generator page by default
        if (generatorPage) {
            generatorPage.classList.add('active');
        }

        nextPageBtn.addEventListener('click', () => {
            // Failsafe: Ensure uploadedBase64 is populated from preview if missing
            if (!uploadedBase64 && previewImage && previewImage.src && previewImage.src.length > 100) {
                uploadedBase64 = previewImage.src;
            }

            // Check if we have any image to print (generated or uploaded)
            if (!generatedImageUrl && !uploadedBase64) {
                showMessage('Please select an image first', 'error');
                return;
            } else if (!generatedImageUrl && uploadedBase64) {
                // Silent fallback to uploaded image
                console.log('Using uploaded image as fallback');
            }

            // Hide generator page, show print page
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));

            // Show first page as inactive, then print page as active
            printPage.classList.add('active');

            // Generate initial layout
            generatePrintLayout();
        });

        backBtn.addEventListener('click', () => {
            printPage.classList.remove('active');
            const pages = document.querySelectorAll('.page');
            pages.forEach((page, index) => {
                if (index === 0) page.classList.add('active');
            });
        });

        layoutSelect.addEventListener('change', generatePrintLayout);

        // --- NEW FUNCTIONS FOR ENHANCED PRINT PAGE ---

        let currentPadding = 0; // mm
        let currentGap = 3.5; // mm

        function generatePrintLayout() {
            const layout = document.getElementById('layoutSelect').value;
            const [cols, rows] = layout.split('x').map(Number);

            // Adjust photo Width based on layout to fit A4 (210mm)

            let photoWidth = 38; // Default standard size
            let pagePadding = 2; // Default page padding in mm

            if (cols === 2) {
                photoWidth = 50;
                currentGap = 15;
            } else if (cols === 5) {
                // 5x1 Fix
                // 5 photos * 38mm = 190mm.
                // Page Padding = 5mm per side -> Available Width = 200mm.
                // Remaining for gaps = 10mm.
                // 4 gaps -> 2.5mm gap.
                currentGap = 3.5; // Evenly spaced
                currentPadding = 1.5; // Symmetrical vertical spacing
                pagePadding = 2; // Narrow page padding
                photoWidth = 38;
            } else {
                // 4x1 standard (4*38 = 152mm. Plenty of room)
                currentGap = 10;
                currentPadding = 0;
                pagePadding = 2;
            }

            // Apply Page Padding
            if (a4Container) a4Container.style.padding = `${pagePadding}mm`;

            // Re-render
            a4Container.innerHTML = '';

            // Robust Image Source Fallback
            // Prioritize Generated > Uploaded > Preview DOM
            let imgSrc = generatedImageUrl || uploadedBase64;

            if (!imgSrc && previewImage && previewImage.src && previewImage.src.length > 100) {
                imgSrc = previewImage.src;
            }

            if (!imgSrc) {
                console.warn('No image source available for print layout');
            }

            for (let r = 0; r < rows; r++) {
                addRow(cols, photoWidth, imgSrc);
            }

            applyLayoutStyles();
        }

        function addRow(cols, w, imgSrc) {
            const row = document.createElement('div');
            row.className = 'a4-row';

            for (let c = 0; c < cols; c++) {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'a4-photo';
                // Enforce STRICT sizing and prevent shrinking
                photoDiv.style.width = w + 'mm';
                photoDiv.style.minWidth = w + 'mm';
                photoDiv.style.flexShrink = '0'; // Prevent squishing

                // Aspect ratio 38:48
                const h = w * (48 / 38);
                photoDiv.style.height = h + 'mm';
                photoDiv.style.minHeight = h + 'mm';

                if (imgSrc) {
                    const img = document.createElement('img');
                    img.src = imgSrc;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.display = 'block';
                    photoDiv.appendChild(img);
                } else {
                    photoDiv.innerHTML = '<span style="font-size:10px; color:#ccc;">No Img</span>';
                }

                row.appendChild(photoDiv);
            }
            a4Container.appendChild(row);
        }

        function duplicateRow() {
            if (a4Container.children.length > 0) {
                const lastRow = a4Container.lastElementChild;
                const newRow = lastRow.cloneNode(true);
                a4Container.appendChild(newRow);
            }
        }

        function removeRow() {
            if (a4Container.children.length > 0) {
                a4Container.lastElementChild.remove();
            }
        }

        function adjustLayout(type, val) {
            if (type === 'padding') {
                currentPadding += val;
                if (currentPadding < 0) currentPadding = 0;
            } else if (type === 'gap') {
                currentGap += val;
                if (currentGap < 0) currentGap = 0;
            }
            applyLayoutStyles();
        }

        function applyLayoutStyles() {
            // Apply Gap (Horizontal) to rows
            const rows = document.querySelectorAll('.a4-row');
            rows.forEach(r => {
                r.style.gap = currentGap + 'mm';
                // Apply Top/Bottom Margin (Vertical Spacing)
                // r.style.marginTop = currentPadding + 'mm';
                // r.style.marginBottom = currentPadding + 'mm';
            });

            // Remove inner padding from photos (or reset to 0)
            const photos = document.querySelectorAll('.a4-photo');
            photos.forEach(p => {
                p.style.padding = '0mm';
            });
        }

        // Mobile Fit Logic
        function fitToScreen() {
            const page = document.querySelector('.print-sheet');
            if (!page) return;

            const pageWidth = 794; // A4 px approx
            const windowWidth = window.innerWidth;

            if (windowWidth < pageWidth) {
                const scale = (windowWidth - 20) / pageWidth;
                page.style.transform = `scale(${scale})`;
                page.style.transformOrigin = 'top center';
                page.style.marginBottom = '-50%'; // HACK to reduce whitespace
            } else {
                page.style.transform = '';
                page.style.marginBottom = '';
            }
        }
        window.addEventListener('resize', fitToScreen);
        // Call fitToScreen when showing print page
        const observer = new MutationObserver(() => {
            if (printPage.classList.contains('active')) fitToScreen();
        });
        observer.observe(printPage, { attributes: true, attributeFilter: ['class'] });

    </script>
</body>

</html>