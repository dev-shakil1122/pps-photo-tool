<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8">
    <title>Invoice - Classic</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="classic.css">
</head>

<body>

    <!-- Toolbar -->
    <div class="pdf-toolbar">
        <label style="color: white; margin-right: 15px; display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="toggleTotals" onchange="toggleTotals(this.checked)" style="margin-right: 5px;">
            Show Totals
        </label>
        <button class="action-btn" onclick="adjustAppearance('font', 1)" title="Increase Font"><i
                class="fas fa-font"></i>+</button>
        <button class="action-btn" onclick="adjustAppearance('font', -1)" title="Decrease Font"><i
                class="fas fa-font"></i>-</button>
        <button class="action-btn" onclick="adjustAppearance('row', 1)" title="Increase Row Height"><i
                class="fas fa-arrows-alt-v"></i>+</button>
        <button class="action-btn" onclick="adjustAppearance('row', -1)" title="Decrease Row Height"><i
                class="fas fa-arrows-alt-v"></i>-</button>

        <button class="action-btn" onclick="adjustAppearance('padTop', 10)" title="Increase Top Margin"><i
                class="fas fa-arrow-up"></i>+</button>
        <button class="action-btn" onclick="adjustAppearance('padTop', -10)" title="Decrease Top Margin"><i
                class="fas fa-arrow-up"></i>-</button>

        <button class="action-btn" onclick="document.getElementById('letterheadUpload').click()"
            title="Change Letterhead"><i class="fas fa-plus"></i> Letterhead</button>
        <button class="action-btn" onclick="removeLetterhead()" title="Remove Letterhead" style="color: #ff6b6b;"><i
                class="fas fa-trash-alt"></i> Letterhead</button>

        <!-- Multiple Images -->
        <button class="action-btn" onclick="document.getElementById('imageUpload').click()" title="Add Image">
            <i class="fas fa-images"></i> Seal/Sign
        </button>
        <button class="action-btn" onclick="removeSelectedImage()" title="Remove Selected Image"
            style="color: #ff6b6b;">
            <i class="fas fa-trash"></i> Remove
        </button>

        <button class="action-btn" onclick="window.print()" title="Print"><i class="fas fa-print"></i></button>
        <button class="action-btn" onclick="downloadPDF()" title="Download PDF"><i class="fas fa-file-pdf"></i></button>
        <!-- Hidden Upload for Toolbar -->
        <input type="file" id="letterheadUpload" accept="image/*" style="display: none;"
            onchange="updateLetterhead(this)">
        <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
    </div>

    <div class="page" id="invoicePage">
        <div class="content-wrapper" id="contentWrapper">

            <!-- Header Row: Meta Left, Title Right -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px;">

                <!-- Meta Data (Left) -->
                <div class="meta-column"
                    style="text-align: left; font-size: var(--font-size); font-weight: bold; width: 50%;">

                    <div class="meta-line" style="position: relative;" contenteditable="true">
                        <span id="refNo">INV # : </span>
                        <div class="row-controls" style="left: -25px; top: 0;">
                            <button class="control-btn btn-add" onclick="addMetaLine(this)">+</button>
                            <button class="control-btn btn-rem" onclick="removeMetaLine(this)">-</button>
                        </div>
                    </div>

                    <div class="meta-line" style="position: relative; padding: 5px 0;" contenteditable="true">
                        <span id="date">Invoice Date : </span>
                        <div class="row-controls" style="left: -25px; top: 0;">
                            <button class="control-btn btn-add" onclick="addMetaLine(this)">+</button>
                            <button class="control-btn btn-rem" onclick="removeMetaLine(this)">-</button>
                        </div>
                    </div>

                    <div class="meta-line" style="position: relative;" contenteditable="true">
                        <span id="dueDate">Due Date : </span>
                        <div class="row-controls" style="left: -25px; top: 0;">
                            <button class="control-btn btn-add" onclick="addMetaLine(this)">+</button>
                            <button class="control-btn btn-rem" onclick="removeMetaLine(this)">-</button>
                        </div>
                    </div>

                </div>

                <!-- Title (Right) -->
                <div class="title-column" style="text-align: right; width: 50%;">
                    <h1 style="font-size: 45px; margin: 0; text-transform: uppercase; text-decoration: underline;">
                        INVOICE</h1>
                </div>

            </div>

            <!-- Boxed Info -->
            <div class="info-boxes">
                <div class="box-left">
                    <div class="box-header">Bill To:</div>
                    <!-- Content injected via JS -->
                    <div id="attnContent">
                        <!-- Placeholder -->
                    </div>
                </div>
                <div class="box-right">
                    <div class="box-header">From:</div>
                    <!-- Content injected via JS -->
                    <div id="fromContent">
                        <!-- Placeholder -->
                    </div>
                </div>
            </div>

            <!-- Subject -->
            <div id="subjectLine" class="subject-block" style="display: none; margin-bottom: 15px; margin-top: 50px;"
                contenteditable="true"></div>

            <!-- Table -->
            <table>
                <thead>
                    <tr>
                        <th class="col-sn">S#</th>
                        <th class="col-desc">Description</th>
                        <th class="col-unit">Unit</th>
                        <th class="col-qty">Qty</th>
                        <th class="col-rate">Rate (QAR)</th>
                        <th class="col-total">Total (QAR)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows injected via JS -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" style="text-align: right; font-weight: bold; font-size: 16px;">Grand Total</td>
                        <td id="grandTotal" style="font-weight: bold; font-size: 16px;">0.00</td>
                    </tr>
                </tfoot>
            </table>

            <!-- In Words -->
            <div id="inWordsRow" style="margin-bottom: 20px; font-weight: bold; font-size: var(--font-size);">
                In Word: <span id="amountInWords" contenteditable="true"></span>
            </div>

            <!-- Note -->
            <div id="noteSection" style="margin-bottom: 20px; font-size: var(--font-size);" contenteditable="true">
                <span style="font-weight: bold;">Note:</span> <span id="noteText"></span>
            </div>



            <div class="closing-text" contenteditable="true">
                <br><br>
                Best Regards,
            </div>

            <div class="signature-line" contenteditable="true">
                Authorized Signature
            </div>

        </div>
    </div>

    <!-- Logic -->
    <script>
        // Number to Words Helper (Simplified for QAR)
        function numberToWords(amount) {
            // Placeholder: Basic implementation or library recommended for full robust conversion
            // For now, let's just return a placeholder or simple logic
            // Ideally, include a small library or function.
            // Converting number to words is complex.
            // I'll provide a user notification in the field to fill it if generic.
            // Or implemented a basic mapping if strictly needed.
            // For this iteration, I'll default to formatting the number logic if user wants words.
            // Actually, let's try a simple recursive function.

            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];

            function convert(n) {
                if (n < 10) return ones[n];
                if (n < 20) return teens[n - 10];
                if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 !== 0 ? ' ' + ones[n % 10] : '');
                if (n < 1000) return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 !== 0 ? ' ' + convert(n % 100) : '');
                if (n < 1000000) return convert(Math.floor(n / 1000)) + ' Thousand' + (n % 1000 !== 0 ? ' ' + convert(n % 1000) : '');
                return n; // Fallback for very large numbers
            }

            const whole = Math.floor(amount);
            const decimal = Math.round((amount - whole) * 100);

            let words = convert(whole) + ' Qatari Riyals';
            if (decimal > 0) words += ' and ' + convert(decimal) + ' Dirhams';
            return words + ' Only';
        }

        // Auto-Fit Function (Removed for PC Only)
        // Monitor Toolbar Height (Removed for PC Only)

        // Removed old observer for contentWrapper as we are scaling the whole page now


        // Load Data
        document.addEventListener('DOMContentLoaded', () => {
            // Global click listener for deselecting images
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.floating-image') && !e.target.classList.contains('action-btn')) {
                    setActiveImage(null);
                }
            });

            const data = JSON.parse(localStorage.getItem('invoiceData'));
            if (data) {
                // Meta Data Injection
                document.getElementById('refNo').innerText = `Invoice No: ${data.ref_no || ''}`;
                document.getElementById('date').innerText = `Invoice Date: ${data.date || ''}`;
                document.getElementById('dueDate').innerText = `Due Date: ${data.due_date || ''}`;

                // Populate Attention
                const controls = `<div class="row-controls" style="left: -25px; top: 0;">
                    <button class="control-btn btn-add" onclick="addAddressLine(this)">+</button>
                    <button class="control-btn btn-rem" onclick="removeAddressLine(this)">-</button>
                </div>`;

                let attnHtml = '';
                if (data.attn.name) attnHtml += `<div class="address-line" style="font-weight:bold; position: relative;" contenteditable="true">${data.attn.name}${controls}</div>`;
                if (data.attn.company) attnHtml += `<div class="address-line" style="position: relative;" contenteditable="true">${data.attn.company}${controls}</div>`;
                if (data.attn.phone) attnHtml += `<div class="address-line" style="position: relative;" contenteditable="true">Mobile: ${data.attn.phone}${controls}</div>`;
                if (data.attn.email) attnHtml += `<div class="address-line" style="position: relative;" contenteditable="true">Email: ${data.attn.email}${controls}</div>`;
                if (data.attn.po_box) attnHtml += `<div class="address-line" style="position: relative;" contenteditable="true">PO Box: ${data.attn.po_box}${controls}</div>`;
                if (data.attn.location) attnHtml += `<div class="address-line" style="position: relative;" contenteditable="true">${data.attn.location}${controls}</div>`;
                document.getElementById('attnContent').innerHTML = attnHtml || '...';

                // Populate From
                let fromHtml = '';
                if (data.from.name) fromHtml += `<div class="address-line" style="font-weight:bold; position: relative;" contenteditable="true">${data.from.name}${controls}</div>`;
                if (data.from.company) fromHtml += `<div class="address-line" style="position: relative;" contenteditable="true"><strong>${data.from.company}</strong>${controls}</div>`;
                if (data.from.mobile) fromHtml += `<div class="address-line" style="position: relative;" contenteditable="true">Mobile: ${data.from.mobile}${controls}</div>`;
                if (data.from.email) fromHtml += `<div class="address-line" style="position: relative;" contenteditable="true">Email: ${data.from.email}${controls}</div>`;

                // From PO Box + Location Combined
                let fromLoc = [];
                if (data.from.po_box) fromLoc.push(`PO Box: ${data.from.po_box}`);
                if (data.from.location) fromLoc.push(data.from.location);
                if (fromLoc.length > 0) {
                    fromHtml += `<div class="address-line" style="position: relative;" contenteditable="true">${fromLoc.join(', ')}${controls}</div>`;
                }

                document.getElementById('fromContent').innerHTML = fromHtml || '...';

                // Subject
                if (data.subject) {
                    document.getElementById('subjectLine').style.display = 'block';
                    document.getElementById('subjectLine').innerText = ` ${data.subject}`;
                }

                // Table
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                if (data.items && data.items.length > 0) {
                    data.items.forEach((item, index) => {
                        addRow(item, index + 1);
                    });
                } else {
                    addRow({}, 1);
                }

                // Calculations
                updateCalculations();



                // Note
                if (data.note) {
                    document.getElementById('noteText').innerText = data.note;
                }

                // Letterhead
                if (data.letterhead) {
                    applyLetterhead(data.letterhead);
                }

                // Totals
                const showTotals = data.hasOwnProperty('show_totals') ? data.show_totals : true;
                document.getElementById('toggleTotals').checked = showTotals;
                toggleTotals(showTotals);

                // Load Images
                const savedImages = JSON.parse(localStorage.getItem('invoiceImages'));
                if (savedImages && Array.isArray(savedImages)) {
                    savedImages.forEach(img => {
                        addImageElement(img.id, img.src, img.x, img.y, img.w, img.h);
                    });
                }
            }
        });

        // Multi-Image Logic
        let activeImageId = null;

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const id = Date.now().toString();
                    addImageElement(id, e.target.result);
                    saveImagesState();
                };
                reader.readAsDataURL(input.files[0]);
                input.value = '';
            }
        }

        function addImageElement(id, src, x = 50, y = 500, w = 150, h = 150) {
            const container = document.createElement('div');
            container.className = 'floating-image';
            container.id = id;
            container.style.left = x + 'px';
            container.style.top = y + 'px';
            container.style.width = w + 'px';
            container.style.height = h + 'px';

            container.addEventListener('mousedown', function (e) {
                if (e.target.classList.contains('resize-handle')) return;
                setActiveImage(id);
            });

            const img = document.createElement('img');
            img.src = src;
            container.appendChild(img);

            ['se'].forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `img-resize-handle handle-${pos}`;
                container.appendChild(handle);
            });

            document.getElementById('invoicePage').appendChild(container); // Append to invoicePage
            makeDraggable(container);
            makeResizable(container);
            setActiveImage(id);
        }

        function setActiveImage(id) {
            document.querySelectorAll('.floating-image').forEach(el => el.classList.remove('active'));
            activeImageId = id;
            if (id) document.getElementById(id)?.classList.add('active');
        }

        function removeSelectedImage() {
            if (activeImageId) {
                document.getElementById(activeImageId)?.remove();
                activeImageId = null;
                saveImagesState();
            }
        }

        function saveImagesState() {
            const images = [];
            document.querySelectorAll('.floating-image').forEach(el => {
                images.push({
                    id: el.id,
                    src: el.querySelector('img').src,
                    x: parseInt(el.style.left),
                    y: parseInt(el.style.top),
                    w: parseInt(el.style.width),
                    h: parseInt(el.style.height)
                });
            });
            localStorage.setItem('invoiceImages', JSON.stringify(images));
        }

        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.addEventListener('mousedown', dragMouseDown);
            elmnt.addEventListener('touchstart', dragMouseDown, { passive: false });

            function dragMouseDown(e) {
                if (e.target.classList.contains('resize-handle')) return;

                pos3 = e.clientX || e.touches[0].clientX;
                pos4 = e.clientY || e.touches[0].clientY;

                document.addEventListener('mouseup', closeDragElement);
                document.addEventListener('touchend', closeDragElement);
                document.addEventListener('mousemove', elementDrag);
                document.addEventListener('touchmove', elementDrag, { passive: false });
            }

            function elementDrag(e) {
                e.preventDefault();
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;

                pos1 = pos3 - clientX;
                pos2 = pos4 - clientY;
                pos3 = clientX;
                pos4 = clientY;

                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.removeEventListener('mouseup', closeDragElement);
                document.removeEventListener('touchend', closeDragElement);
                document.removeEventListener('mousemove', elementDrag);
                document.removeEventListener('touchmove', elementDrag);
                saveImagesState();
            }
        }

        function makeResizable(elmnt) {
            const handles = elmnt.querySelectorAll('.img-resize-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', initResize);
                handle.addEventListener('touchstart', initResize, { passive: false });

                function initResize(e) {
                    if (e.type === 'mousedown') {
                        e.preventDefault(); e.stopPropagation();
                    }

                    const startX = e.clientX || e.touches[0].clientX;
                    const startWidth = parseInt(document.defaultView.getComputedStyle(elmnt).width, 10);
                    const startHeight = parseInt(document.defaultView.getComputedStyle(elmnt).height, 10);
                    const aspectRatio = startWidth / startHeight;

                    function doDrag(e) {
                        if (e.type === 'touchmove') e.preventDefault();
                        const clientX = e.clientX || e.touches[0].clientX;

                        const dx = clientX - startX;
                        const newWidth = startWidth + dx;
                        if (newWidth > 20) {
                            elmnt.style.width = newWidth + 'px';
                            elmnt.style.height = (newWidth / aspectRatio) + 'px';
                        }
                    }

                    function stopDrag() {
                        document.removeEventListener('mousemove', doDrag);
                        document.removeEventListener('touchmove', doDrag);
                        document.removeEventListener('mouseup', stopDrag);
                        document.removeEventListener('touchend', stopDrag);
                        saveImagesState();
                    }

                    document.addEventListener('mousemove', doDrag);
                    document.addEventListener('touchmove', doDrag, { passive: false });
                    document.addEventListener('mouseup', stopDrag);
                    document.addEventListener('touchend', stopDrag);
                }
            });
        }

        // --- Reuse shared functions ---

        function applyLetterhead(base64Img) {
            const page = document.getElementById('invoicePage');
            page.style.backgroundImage = `url('${base64Img}')`;
            document.body.classList.add('has-letterhead');
        }

        function updateLetterhead(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const base64 = e.target.result;
                    applyLetterhead(base64);
                    // Update LocalStorage
                    const data = JSON.parse(localStorage.getItem('invoiceData'));
                    if (data) {
                        data.letterhead = base64;
                        localStorage.setItem('invoiceData', JSON.stringify(data));
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeLetterhead() {
            const page = document.getElementById('invoicePage');
            page.style.backgroundImage = 'none';
            document.body.classList.remove('has-letterhead');

            // Update LocalStorage
            const data = JSON.parse(localStorage.getItem('invoiceData'));
            if (data) {
                data.letterhead = null;
                localStorage.setItem('invoiceData', JSON.stringify(data));
            }
        }

        function addRow(item = {}, index) {
            const tbody = document.getElementById('tableBody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="position: relative;">
                    ${index}
                    <div class="row-controls">
                        <button class="control-btn btn-add" onclick="addNewRow(this)">+</button>
                        <button class="control-btn btn-rem" onclick="removeRow(this)">-</button>
                    </div>
                </td>
                <td contenteditable="true" class="desc-cell">${item.desc || ''}</td>
                <td contenteditable="true">${item.unit || ''}</td>
                <td contenteditable="true" class="qty-cell" oninput="calculateRow(this)">${item.qty || ''}</td>
                <td contenteditable="true" class="rate-cell" oninput="calculateRow(this)">${item.rate ? parseFloat(item.rate).toFixed(2) : ''}</td>
                <td class="total-cell">0.00</td>
            `;
            tbody.appendChild(tr);
            const rowQty = parseFloat(item.qty) || 0;
            const rowRate = parseFloat(item.rate) || 0;
            tr.querySelector('.total-cell').innerText = (rowQty * rowRate).toFixed(2);
        }

        function calculateRow(el) {
            const tr = el.closest('tr');
            const qty = parseFloat(tr.querySelector('.qty-cell').innerText) || 0;
            const rate = parseFloat(tr.querySelector('.rate-cell').innerText) || 0;
            const total = qty * rate;
            tr.querySelector('.total-cell').innerText = total.toFixed(2);
            updateGrandTotal();
        }

        function updateGrandTotal() {
            let sum = 0;
            document.querySelectorAll('.total-cell').forEach(cell => {
                sum += parseFloat(cell.innerText) || 0;
            });
            document.getElementById('grandTotal').innerText = sum.toFixed(2);
            // Update In Words
            document.getElementById('amountInWords').innerText = numberToWords(sum);
        }

        function updateCalculations() {
            document.querySelectorAll('tr').forEach(tr => {
                if (tr.querySelector('.qty-cell')) {
                    const qty = parseFloat(tr.querySelector('.qty-cell').innerText) || 0;
                    const rate = parseFloat(tr.querySelector('.rate-cell').innerText) || 0;
                    tr.querySelector('.total-cell').innerText = (qty * rate).toFixed(2);
                }
            });
            updateGrandTotal();
        }

        window.addNewRow = function (btn) {
            const tr = btn.closest('tr');
            const newTr = tr.cloneNode(true);
            newTr.querySelectorAll('td[contenteditable]').forEach(td => td.innerText = '');
            newTr.querySelector('.total-cell').innerText = '0.00';
            tr.parentNode.insertBefore(newTr, tr.nextSibling);
            renumberRows();
        };

        window.removeRow = function (btn) {
            const tr = btn.closest('tr');
            if (document.querySelectorAll('#tableBody tr').length > 1) {
                tr.remove();
                renumberRows();
                updateGrandTotal();
            }
        };

        function renumberRows() {
            document.querySelectorAll('#tableBody tr').forEach((tr, i) => {
                tr.cells[0].childNodes[0].nodeValue = i + 1 + " ";
            });
        }

        // Address Line Actions
        window.addAddressLine = function (btn) {
            const div = btn.closest('.address-line');
            const newDiv = div.cloneNode(true);
            Array.from(newDiv.childNodes).forEach(node => {
                if (node.nodeType === Node.TEXT_NODE) node.nodeValue = "New Line";
            });
            div.parentNode.insertBefore(newDiv, div.nextSibling);
        };

        window.removeAddressLine = function (btn) {
            const div = btn.closest('.address-line');
            const parent = div.parentNode;
            if (parent.querySelectorAll('.address-line').length > 1) {
                div.remove();
            }
        };

        // Meta Line Actions
        window.addMetaLine = function (btn) {
            const div = btn.closest('.meta-line');
            const newDiv = div.cloneNode(true);
            // Reset text logic if needed, or keep clone
            div.parentNode.insertBefore(newDiv, div.nextSibling);
        };

        window.removeMetaLine = function (btn) {
            const div = btn.closest('.meta-line');
            const parent = div.parentNode;
            if (parent.querySelectorAll('.meta-line').length > 1) {
                div.remove();
            }
        };

        function toggleTotals(show) {
            if (show) {
                document.body.classList.remove('no-totals');
            } else {
                document.body.classList.add('no-totals');
            }
        }

        // Appearance
        let currentFontSize = 14;
        let currentRowPadding = 8;
        let currentPadTop = 130;
        let currentPadBtm = 50;

        function adjustAppearance(type, step) {
            if (type === 'font') {
                currentFontSize += step;
                if (currentFontSize < 8) currentFontSize = 8;
                document.documentElement.style.setProperty('--font-size', currentFontSize + 'px');
            } else if (type === 'row') {
                currentRowPadding += step;
                if (currentRowPadding < 2) currentRowPadding = 2;
                document.documentElement.style.setProperty('--row-padding', currentRowPadding + 'px');
            } else if (type === 'padTop') {
                currentPadTop += step;
                if (currentPadTop < 0) currentPadTop = 0;
                document.documentElement.style.setProperty('--pad-top', currentPadTop + 'px');
            } else if (type === 'padBtm') {
                currentPadBtm += step;
                if (currentPadBtm < 0) currentPadBtm = 0;
                document.documentElement.style.setProperty('--pad-bottom', currentPadBtm + 'px');
            }
        }




        // Export
        function downloadPDF() {
            // Hide controls explicitly
            const controls = document.querySelectorAll('.resize-handle, .img-resize-handle, .row-controls, .li-controls, .action-btn');
            const displayStates = [];
            controls.forEach(c => {
                displayStates.push({ el: c, val: c.style.display });
                c.style.display = 'none';
            });

            const element = document.querySelector('.page');
            document.body.classList.add('generating-pdf');

            // Save state
            const originalTransform = element.style.transform;
            const originalMargin = element.style.margin;
            const originalHeight = element.style.height;
            const originalOverflow = element.style.overflow;

            // Strict Reset
            element.style.transform = 'none';
            element.style.margin = '0';
            element.style.marginLeft = '0';
            element.style.marginBottom = '0';

            // Force Single Page A4 (Strict Height)
            element.style.setProperty('min-height', '0', 'important');
            element.style.setProperty('height', '290mm', 'important');
            element.style.overflow = 'hidden';

            window.scrollTo(0, 0);

            const opt = {
                margin: 0,
                filename: 'Invoice.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    scrollY: 0
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                document.body.classList.remove('generating-pdf');

                // Restore controls
                controls.forEach((c, i) => {
                    c.style.display = displayStates[i].val;
                });

                // Restore state
                element.style.height = originalHeight;
                element.style.overflow = originalOverflow;
                element.style.margin = originalMargin;

                element.style.margin = originalMargin; // Restore original margin (60px auto)
            });
        }

        // Column Resizing Logic
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initResizeHandles, 100);
        });

        function initResizeHandles() {
            const cols = document.querySelectorAll('th');
            cols.forEach(col => {
                if (col.querySelector('.resize-handle')) return;
                const handle = document.createElement('div');
                handle.className = 'resize-handle';
                col.appendChild(handle);
                setResizable(col, handle);
            });
        }

        function setResizable(col, handle) {
            let startX, startWidth, nextCol, nextStartWidth;

            handle.addEventListener('mousedown', function (e) {
                e.preventDefault();
                nextCol = col.nextElementSibling;
                if (!nextCol) return;

                startX = e.pageX;
                startWidth = col.offsetWidth;
                nextStartWidth = nextCol.offsetWidth;

                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                const diffX = e.pageX - startX;
                const newW = startWidth + diffX;
                const nextNewW = nextStartWidth - diffX;

                if (newW > 30 && nextNewW > 30) {
                    col.style.width = newW + 'px';
                    nextCol.style.width = nextNewW + 'px';
                }
            }

            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                document.body.style.cursor = 'default';
                document.body.style.userSelect = '';
            }
        }
    </script>
</body>

</html>