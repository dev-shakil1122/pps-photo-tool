<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8">
    <title>Salary Certificate</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="classic.css?v=2">
</head>

<body>

    <div class="pdf-toolbar">
        <!-- Font Control -->
        <button class="action-btn" onclick="adjustAppearance('font', 1)">A +</button>
        <button class="action-btn" onclick="adjustAppearance('font', -1)">A -</button>

        <!-- Line Spacing -->
        <button class="action-btn" onclick="adjustAppearance('line', 0.1)"><i class="fas fa-arrows-alt-v"></i>
            +</button>
        <button class="action-btn" onclick="adjustAppearance('line', -0.1)"><i class="fas fa-arrows-alt-v"></i>
            -</button>

        <!-- Margin -->
        <button class="action-btn" onclick="adjustAppearance('margin', 10)"><i class="fas fa-arrow-down"></i> +</button>
        <button class="action-btn" onclick="adjustAppearance('margin', -10)"><i class="fas fa-arrow-up"></i> -</button>

        <!-- Letterhead -->
        <button class="action-btn" onclick="document.getElementById('letterheadUpload').click()">
            <i class="fas fa-plus"></i> Letterhead
        </button>
        <button class="action-btn btn-danger" onclick="removeLetterhead()">
            <i class="fas fa-trash-alt"></i> Letterhead
        </button>

        <!-- Multiple Images -->
        <button class="action-btn" onclick="document.getElementById('imageUpload').click()" title="Add Image">
            <i class="fas fa-images"></i> Seal/Sign
        </button>
        <button class="action-btn btn-danger" onclick="removeSelectedImage()" title="Remove Selected Image">
            <i class="fas fa-trash"></i> Remove
        </button>


        <!-- Actions -->
        <button class="action-btn" onclick="window.print()" title="Print"><i class="fas fa-print"></i></button>
        <button class="action-btn" onclick="generatePDF()" title="Download PDF"><i class="fas fa-file-pdf"></i></button>
        <button class="action-btn" onclick="history.back()" title="Back"><i class="fas fa-arrow-left"></i></button>

        <input type="file" id="letterheadUpload" accept="image/*" style="display: none;"
            onchange="handleLetterhead(this)">
        <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
    </div>

    <div class="page" id="certPage">

        <div class="date-section">
            Date: <span id="displayDate"></span>
        </div>

        <div class="recipient-section" contenteditable="true">To,<br>The Manager,<br><span id="displayAddress"></span>
        </div>

        <div class="salutation" contenteditable="true">
            Dear Sir:
        </div>

        <div class="body-text" contenteditable="true">
            This is to certify that Mr./Ms. <strong id="displayName"></strong>, QID No: <strong
                id="displayQid"></strong> is a Confirmed employee of <span id="displayCompany1"></span>. He/She joined
            the company on <span id="displayJoinDate"></span> and currently working as <strong
                id="displayPosition"></strong> in <span id="displayDepartment"></span> Department. His/Her present
            salary is QAR <strong id="displaySalary"></strong> per month.
        </div>

        <div class="body-text" contenteditable="true">
            To assist Mr./Ms. <strong id="displayName2"></strong> in obtaining an Account Opening from your bank, we
            confirm that this monthly salary will continue to be paid to his/her bank account with <span
                id="displayBankName"></span> effective immediately.
        </div>

        <div class="footer-section">
            <p contenteditable="true">Yours truly,</p>
            <p class="company-signature" contenteditable="true" id="displayCompany2"></p>
        </div>

    </div>

    <script>
        let config = {
            fontSize: 16,
            lineHeight: 1.5,
            paddingTop: 2.54 // cm
        };

        const cmToPx = 37.7952755906;

        document.addEventListener('DOMContentLoaded', () => {
            // Global click listener for deselecting images
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.floating-image') && !e.target.classList.contains('action-btn')) {
                    setActiveImage(null);
                }
            });

            // Load Data
            const data = JSON.parse(localStorage.getItem('salaryData'));
            if (data) {
                document.getElementById('displayDate').innerText = formatDate(data.date);
                document.getElementById('displayAddress').innerText = data.bankAddress && data.bankAddress.trim() !== '' ? data.bankAddress : 'The Commercial Bank of Qatar\nP.O. Box 3232\nDoha, Qatar';

                document.getElementById('displayName').innerText = data.employeeName || '......';
                document.getElementById('displayName2').innerText = data.employeeName || '......';

                document.getElementById('displayQid').innerText = data.qid || '......';
                document.getElementById('displayCompany1').innerText = data.companyName || 'the company';
                document.getElementById('displayCompany2').innerText = data.companyName || '(Company Name)';

                document.getElementById('displayJoinDate').innerText = formatDate(data.joiningDate);
                document.getElementById('displayPosition').innerText = data.jobPosition || '......';
                document.getElementById('displayDepartment').innerText = data.department || '......';
                document.getElementById('displaySalary').innerText = data.salary || '......';

                // Extract Bank Name from "The Commercial Bank of Qatar\n..." -> "The Commercial Bank of Qatar"
                // Or use the dropdown value if simpler?
                // Let's guess from the first line of address
                let bankName = "the bank";
                if (data.bankAddress) {
                    bankName = data.bankAddress.split('\n')[0];
                }
                document.getElementById('displayBankName').innerText = bankName;
            }

            // Load Letterhead
            const savedLetterhead = localStorage.getItem('salaryLetterhead');
            if (savedLetterhead) applyLetterhead(savedLetterhead);

            // Load Images
            const savedImages = JSON.parse(localStorage.getItem('salaryImages'));
            if (savedImages && Array.isArray(savedImages)) {
                savedImages.forEach(img => {
                    addImageElement(img.id, img.src, img.x, img.y, img.w, img.h);
                });
            }
        });

        function formatDate(dateStr) {
            if (!dateStr) return '......';
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateStr).toLocaleDateString('en-US', options);
        }

        // Appearance
        function adjustAppearance(type, value) {
            const root = document.documentElement;
            if (type === 'font') {
                config.fontSize += value;
                root.style.setProperty('--font-size', config.fontSize + 'px');
            } else if (type === 'line') {
                config.lineHeight += value;
                root.style.setProperty('--line-height', config.lineHeight);
            } else if (type === 'margin') {
                // adjust padding-top
                let currentPadding = parseFloat(getComputedStyle(document.querySelector('.page')).paddingTop); // px
                let newPadding = currentPadding + value;
                document.querySelector('.page').style.paddingTop = newPadding + 'px';
            }
        }

        // Letterhead
        function handleLetterhead(input) {
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    applyLetterhead(e.target.result);
                    localStorage.setItem('salaryLetterhead', e.target.result);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function applyLetterhead(url) {
            document.getElementById('certPage').style.backgroundImage = `url('${url}')`;
        }
        function removeLetterhead() {
            document.getElementById('certPage').style.backgroundImage = 'none';
            localStorage.removeItem('salaryLetterhead');
        }

        // Multi-Image Logic (Reused)
        let activeImageId = null;

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const id = Date.now().toString();
                    addImageElement(id, e.target.result);
                    saveImagesState();
                };
                reader.readAsDataURL(input.files[0]);
                input.value = '';
            }
        }

        function addImageElement(id, src, x = 50, y = 500, w = 150, h = 150) {
            const container = document.createElement('div');
            container.className = 'floating-image';
            container.id = id;
            container.style.left = x + 'px';
            container.style.top = y + 'px';
            container.style.width = w + 'px';
            container.style.height = h + 'px';

            container.addEventListener('mousedown', function (e) {
                if (e.target.classList.contains('resize-handle')) return;
                setActiveImage(id);
            });

            const img = document.createElement('img');
            img.src = src;
            container.appendChild(img);

            ['se'].forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `resize-handle handle-${pos}`;
                container.appendChild(handle);
            });

            document.getElementById('certPage').appendChild(container);
            makeDraggable(container);
            makeResizable(container);
            setActiveImage(id);
        }

        function setActiveImage(id) {
            document.querySelectorAll('.floating-image').forEach(el => el.classList.remove('active'));
            activeImageId = id;
            if (id) document.getElementById(id)?.classList.add('active');
        }

        function removeSelectedImage() {
            if (activeImageId) {
                document.getElementById(activeImageId)?.remove();
                activeImageId = null;
                saveImagesState();
            }
        }

        function saveImagesState() {
            const images = [];
            document.querySelectorAll('.floating-image').forEach(el => {
                images.push({
                    id: el.id,
                    src: el.querySelector('img').src,
                    x: parseInt(el.style.left),
                    y: parseInt(el.style.top),
                    w: parseInt(el.style.width),
                    h: parseInt(el.style.height)
                });
            });
            localStorage.setItem('salaryImages', JSON.stringify(images));
        }

        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.addEventListener('mousedown', dragMouseDown);
            elmnt.addEventListener('touchstart', dragMouseDown, { passive: false });

            function dragMouseDown(e) {
                if (e.target.classList.contains('resize-handle')) return;

                pos3 = e.clientX || e.touches[0].clientX;
                pos4 = e.clientY || e.touches[0].clientY;

                document.addEventListener('mouseup', closeDragElement);
                document.addEventListener('touchend', closeDragElement);
                document.addEventListener('mousemove', elementDrag);
                document.addEventListener('touchmove', elementDrag, { passive: false });
            }

            function elementDrag(e) {
                e.preventDefault();
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;

                pos1 = pos3 - clientX;
                pos2 = pos4 - clientY;
                pos3 = clientX;
                pos4 = clientY;

                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.removeEventListener('mouseup', closeDragElement);
                document.removeEventListener('touchend', closeDragElement);
                document.removeEventListener('mousemove', elementDrag);
                document.removeEventListener('touchmove', elementDrag);
                saveImagesState();
            }
        }

        function makeResizable(elmnt) {
            const handles = elmnt.querySelectorAll('.resize-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', initResize);
                handle.addEventListener('touchstart', initResize, { passive: false });

                function initResize(e) {
                    if (e.type === 'mousedown') {
                        e.preventDefault(); e.stopPropagation();
                    }

                    const startX = e.clientX || e.touches[0].clientX;
                    const startWidth = parseInt(document.defaultView.getComputedStyle(elmnt).width, 10);
                    const startHeight = parseInt(document.defaultView.getComputedStyle(elmnt).height, 10);
                    const aspectRatio = startWidth / startHeight;

                    function doDrag(e) {
                        if (e.type === 'touchmove') e.preventDefault();
                        const clientX = e.clientX || e.touches[0].clientX;

                        const dx = clientX - startX;
                        const newWidth = startWidth + dx;
                        if (newWidth > 20) {
                            elmnt.style.width = newWidth + 'px';
                            elmnt.style.height = (newWidth / aspectRatio) + 'px';
                        }
                    }

                    function stopDrag() {
                        document.removeEventListener('mousemove', doDrag);
                        document.removeEventListener('touchmove', doDrag);
                        document.removeEventListener('mouseup', stopDrag);
                        document.removeEventListener('touchend', stopDrag);
                        saveImagesState();
                    }

                    document.addEventListener('mousemove', doDrag);
                    document.addEventListener('touchmove', doDrag, { passive: false });
                    document.addEventListener('mouseup', stopDrag);
                    document.addEventListener('touchend', stopDrag);
                }
            });
        }

        // Monitor Toolbar Height Changes
        document.addEventListener('DOMContentLoaded', () => {
            // Logic removed as per request
        });


        function generatePDF() {
            // 1. Prepare for Print: Remove handles, Reset Scale & Margins
            const handles = document.querySelectorAll('.resize-handle');
            handles.forEach(h => h.style.display = 'none');

            const element = document.querySelector('.page');

            // Save current state
            const originalTransform = element.style.transform;
            const originalMarginBottom = element.style.marginBottom;
            const originalMarginTop = element.style.marginTop;
            const originalMarginLeft = element.style.marginLeft;

            // Strict Reset for Capture
            element.style.transform = 'none';
            element.style.marginBottom = '0';
            element.style.marginTop = '0'; // Critical for removing extra page
            element.style.marginLeft = '0';
            // Fix for Extra Page: Reduce height slightly to prevent overflow
            element.style.height = '296mm'; // 297mm is full A4, 296mm ensures single page
            element.style.overflow = 'hidden';
            element.style.border = 'none'; // Ensure no border adds size

            // Scroll to top to ensure clean capture
            window.scrollTo(0, 0);

            const opt = {
                margin: 0,
                filename: 'Salary_Certificate.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    letterRendering: true,
                    scrollY: 0
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                // 2. Restore State
                handles.forEach(h => h.style.display = '');

                // Restore responsive view (fitToScreen will handle transforms)

                // Restore style properties
                element.style.marginTop = '';
                element.style.marginLeft = '';
                element.style.height = ''; // Allow auto height or CSS height
                element.style.overflow = '';
                element.style.border = '';
            });
        }
    </script>
</body>

</html>